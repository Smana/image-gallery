name: Build and Push

on:
  push:
    branches: [ main ]
  workflow_run:
    workflows: ["CI Validation"]
    branches: [ main ]
    types: [completed]

env:
  GO_VERSION: "1.25"
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Only run if CI validation succeeded or this is a direct push to main
  check-ci:
    name: Check CI Status
    runs-on: ubuntu-latest
    outputs:
      proceed: ${{ steps.check.outputs.proceed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if we should proceed
        id: check
        run: |
          # Check if this is a release commit (skip if release-please is handling it)
          if git log -1 --pretty=format:"%s" | grep -E "^(chore|release).*release"; then
            echo "Release commit detected - skipping to avoid duplicate images"
            echo "proceed=false" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            echo "Direct push to main - proceeding"
            echo "proceed=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
            echo "CI validation succeeded - proceeding"
            echo "proceed=true" >> $GITHUB_OUTPUT
          else
            echo "CI validation failed or not completed - skipping"
            echo "proceed=false" >> $GITHUB_OUTPUT
          fi

  docker-build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [check-ci]
    if: needs.check-ci.outputs.proceed == 'true'
    permissions:
      contents: read
      packages: write
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Dagger
        uses: dagger/dagger-for-github@v7
        with:
          version: "latest"

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: dagger/dagger-for-github@v7
        with:
          version: "latest"
          module: "github.com/sagikazarmark/daggerverse/go@v0.9.0"
          call: >-
            with-platform --platform=linux/amd64,linux/arm64
            with-cgo-disabled
            build
            --source=.
            --pkg=./server
            --ldflags="-w -s"
            container
            --base-image=gcr.io/distroless/static-debian12:nonroot
            --binary-name=server
            with-label org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            with-label org.opencontainers.image.revision=${{ github.sha }}
            with-label org.opencontainers.image.created=$(date -u +%Y-%m-%dT%H:%M:%SZ)
            with-label org.opencontainers.image.title=image-gallery
            with-label org.opencontainers.image.description="Modern Go image gallery application"
            with-exposed-port 8080
            publish --address=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Tag as latest
        if: github.ref == 'refs/heads/main'
        uses: dagger/dagger-for-github@v7
        with:
          version: "latest"
          module: "github.com/sagikazarmark/daggerverse/go@v0.9.0"
          call: >-
            with-platform --platform=linux/amd64,linux/arm64
            with-cgo-disabled
            build
            --source=.
            --pkg=./server
            --ldflags="-w -s"
            container
            --base-image=gcr.io/distroless/static-debian12:nonroot
            --binary-name=server
            with-label org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            with-label org.opencontainers.image.revision=${{ github.sha }}
            with-label org.opencontainers.image.created=$(date -u +%Y-%m-%dT%H:%M:%SZ)
            with-label org.opencontainers.image.title=image-gallery
            with-label org.opencontainers.image.description="Modern Go image gallery application"
            with-exposed-port 8080
            publish --address=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: Generate SBOM
        run: |
          echo "📋 Generating Software Bill of Materials..."
          # Note: This would be enhanced with actual SBOM generation
          echo "SBOM generation placeholder - consider integrating syft or similar tools"

  security-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: always() && needs.docker-build.result == 'success'
    permissions:
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Dagger
        uses: dagger/dagger-for-github@v7
        with:
          version: "latest"

      - name: Run Trivy container security scan (SARIF)
        uses: dagger/dagger-for-github@v7
        with:
          version: "latest"
          module: "github.com/jpadams/daggerverse/trivy@v0.6.0"
          call: "scan-image --image-ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} --severity=HIGH,CRITICAL --format=sarif"

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif

      - name: Run Trivy container scan (table format for logs)
        uses: dagger/dagger-for-github@v7
        with:
          version: "latest"
          module: "github.com/jpadams/daggerverse/trivy@v0.6.0"
          call: "scan-image --image-ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} --severity=HIGH,CRITICAL --format=table"

      - name: Run Trivy container scan (JSON for artifact)
        uses: dagger/dagger-for-github@v7
        with:
          version: "latest"
          module: "github.com/jpadams/daggerverse/trivy@v0.6.0"
          call: "scan-image --image-ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} --severity=HIGH,CRITICAL --format=json"

      - name: Upload security scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: |
            trivy-results.sarif
            trivy-results.json
          retention-days: 30

  # Release artifacts (optional - for future use)
  release-artifacts:
    name: Create Release Artifacts
    runs-on: ubuntu-latest
    needs: [docker-build, security-scan]
    if: always() && needs.docker-build.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts from CI
        uses: actions/download-artifact@v4
        with:
          pattern: server-*
          path: ./artifacts/
          merge-multiple: true

      - name: Create release summary
        run: |
          cat > release-notes.md << EOF
          # Image Gallery Release

          **Build**: \`${{ github.sha }}\`
          **Date**: \`$(date -u +%Y-%m-%dT%H:%M:%SZ)\`
          **Go Version**: \`${{ env.GO_VERSION }}\`

          ## Container Images
          - \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}\`
          - \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\`

          ## Platforms
          - linux/amd64
          - linux/arm64

          ## Security
          - ✅ Vulnerability scanning completed
          - ✅ Container security scan passed
          - ✅ Distroless base image

          Generated by GitHub Actions
          EOF

      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release-notes.md
          retention-days: 90

  # Success notification
  deploy-success:
    name: Deployment Complete
    runs-on: ubuntu-latest
    needs: [docker-build, security-scan]
    if: always() && needs.docker-build.result == 'success'
    steps:
      - name: Report deployment status
        run: |
          if [[ "${{ needs.security-scan.result }}" == "success" ]]; then
            echo "🚀 Deployment completed successfully!"
            echo "✅ Container image built and pushed"
            echo "✅ Security scan completed"
            echo ""
            echo "📋 Deployment Summary:"
            echo "  - Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
            echo "  - Latest: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
            echo "  - Platforms: linux/amd64, linux/arm64"
            echo "  - Base: distroless/static-debian12:nonroot"
          else
            echo "⚠️ Deployment completed with warnings"
            echo "✅ Container image built and pushed"
            echo "⚠️ Security scan had issues (check logs)"
          fi
